name: CD - GitOps

on:
  push:
    branches:
      - main

env:
  ACR_NAME: agendadevacr

jobs:
  gitops:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Login Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR login server
        id: acr
        run: |
          LOGIN_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
          echo "LOGIN_SERVER=$LOGIN_SERVER" >> $GITHUB_ENV

      - name: Login no ACR
        run: az acr login --name $ACR_NAME

      - name: Build Backend
        run: |
          docker build -t $LOGIN_SERVER/backend:${{ github.sha }} .
          docker push $LOGIN_SERVER/backend:${{ github.sha }}

      - name: Build Frontend
        run: |
          docker build -t $LOGIN_SERVER/frontend:${{ github.sha }} ./frontend
          docker push $LOGIN_SERVER/frontend:${{ github.sha }}

      - name: Update Backend Image Tag
        run: |
          sed -i "s|backend:REPLACE_ME|backend:${{ github.sha }}|g" deploy/dev/backend.yaml

      - name: Update Frontend Image Tag
        run: |
          sed -i "s|frontend:REPLACE_ME|frontend:${{ github.sha }}|g" deploy/dev/frontend.yaml

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add deploy/dev/
          git commit -m "GitOps deploy ${{ github.sha }}" || echo "No changes"
          git push
